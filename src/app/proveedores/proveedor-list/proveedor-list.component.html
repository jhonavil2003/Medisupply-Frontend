
<div class="container">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
    <div style="display: flex; align-items: center; gap: 16px;">
      <a mat-icon-button [routerLink]="['/dashboard-admin']">
        <mat-icon>arrow_back</mat-icon>
      </a>
      <h2 style="margin: 0;">Gestión de proveedores</h2>
    </div>
    <button mat-raised-button color="primary" (click)="agregarProveedorAleatorio()" aria-label="Agregar proveedor" data-i18n="btn.register">
      <mat-icon>add</mat-icon> Agregar Proveedor
    </button>
  </div>
  <div class="search-bar" style="flex: 1;">
    <div class="search-wrap">
      <mat-form-field appearance="outline" class="search-field">
        <mat-label>Buscar proveedor</mat-label>
        <input matInput
          placeholder="Razón social, RUC, teléfono, correo, estado o certificación..."
          [(ngModel)]="filtroBusqueda"
          (ngModelChange)="filtrarProveedores()"
          (keyup.enter)="filtrarProveedores()"
          />
        @if (filtroBusqueda) {
          <button
            matSuffix
            mat-icon-button
            aria-label="Limpiar"
            (click)="filtroBusqueda=''; filtrarProveedores()" color="primary">
            <mat-icon>close</mat-icon>
          </button>
        }
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>
      <button mat-raised-button color="primary" class="search-btn" (click)="filtrarProveedores()">
        <mat-icon>search</mat-icon>
      </button>
    </div>
  </div>

  <div class="card">
    <table mat-table [dataSource]="dataSource" matSort class="modern-table">
      <ng-container matColumnDef="razonSocial">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Razón Social</th>
        <td mat-cell *matCellDef="let row">{{ row.razonSocial }}</td>
      </ng-container>
      <ng-container matColumnDef="ruc">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>RUC</th>
        <td mat-cell *matCellDef="let row">{{ row.ruc }}</td>
      </ng-container>
      <ng-container matColumnDef="telefono">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Teléfono</th>
        <td mat-cell *matCellDef="let row">{{ row.telefono }}</td>
      </ng-container>
      <ng-container matColumnDef="correoContacto">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Correo de contacto</th>
        <td mat-cell *matCellDef="let row">{{ row.correoContacto }}</td>
      </ng-container>
      <ng-container matColumnDef="estado">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Estado</th>
        <td mat-cell *matCellDef="let row">{{ row.estado }}</td>
      </ng-container>
      <ng-container matColumnDef="certificacionesVigentes">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Certificaciones vigentes</th>
        <td mat-cell *matCellDef="let row">
          @for (cert of row.certificacionesVigentes; track cert; let last = $last) {
            <span>
              {{ cert }}@if (!last) {
              <span>, </span>
            }
          </span>
        }
      </td>
    </ng-container>
    <ng-container matColumnDef="acciones">
      <th mat-header-cell *matHeaderCellDef>Acciones</th>
      <td mat-cell *matCellDef="let row; let i = index" class="actions">
        <button class="btn-icon" title="Ver" (click)="verProveedor(i)"><i class="fas fa-eye"></i></button>
        <button class="btn-icon" title="Editar" (click)="editarProveedor(i)"><i class="fas fa-edit"></i></button>
        <button class="btn-icon danger" title="Eliminar" (click)="eliminarProveedor(i)"><i class="fas fa-trash"></i></button>
      </td>
    </ng-container>
    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
  </table>
  <mat-paginator [pageSize]="10" [pageSizeOptions]="[5, 10, 20]"></mat-paginator>
</div>

<!-- Modal Edición -->
<div class="detalle-modal" [ngStyle]="{display: mostrarModal ? 'flex' : 'none'}">
  @if (proveedorEditando) {
    <div class="detalle-content">
      <button mat-icon-button (click)="cancelarEdicionProveedor()" aria-label="Cerrar" class="close" type="button">
        <mat-icon>close</mat-icon>
      </button>
      <h2>Editar Proveedor</h2>
      <form (ngSubmit)="guardarEdicionProveedor()" class="form-container" #proveedorForm="ngForm">
        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Razón Social</mat-label>
          <input matInput type="text" [(ngModel)]="proveedorEditando.razonSocial" name="razonSocial" required>
        </mat-form-field>
        <mat-form-field appearance="outline" class="form-field">
          <mat-label>RUC</mat-label>
          <input matInput type="text" [(ngModel)]="proveedorEditando.ruc" name="ruc" required>
        </mat-form-field>
        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Teléfono</mat-label>
          <input matInput type="text" [(ngModel)]="proveedorEditando.telefono" name="telefono" required>
        </mat-form-field>
        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Correo de contacto</mat-label>
          <input matInput type="email" [(ngModel)]="proveedorEditando.correoContacto" name="correoContacto" required>
        </mat-form-field>
        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Estado</mat-label>
          <mat-select [(ngModel)]="proveedorEditando.estado" name="estado">
            <mat-option value="Activo">Activo</mat-option>
            <mat-option value="Inactivo">Inactivo</mat-option>
          </mat-select>
        </mat-form-field>
        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Certificaciones vigentes</mat-label>
          <input matInput type="text" [(ngModel)]="proveedorEditando.certificacionesVigentes" name="certificacionesVigentes" placeholder="Separadas por coma">
        </mat-form-field>
        <div class="form-actions">
          <button mat-flat-button color="primary" type="submit">Guardar</button>
        </div>
      </form>
    </div>
  }
</div>

<!-- Modal Detalle -->
<div class="detalle-modal" [ngStyle]="{display: mostrarDetalle ? 'flex' : 'none'}">
  @if (proveedorDetalle) {
    <div class="detalle-content">
      <button mat-icon-button (click)="cerrarDetalleProveedor()" aria-label="Cerrar" class="close" type="button">
        <mat-icon>close</mat-icon>
      </button>
      <h2>Detalle del Proveedor</h2>
      <p><strong>Razón Social:</strong> {{ proveedorDetalle.razonSocial }}</p>
      <p><strong>RUC:</strong> {{ proveedorDetalle.ruc }}</p>
      <p><strong>Teléfono:</strong> {{ proveedorDetalle.telefono }}</p>
      <p><strong>Correo de contacto:</strong> {{ proveedorDetalle.correoContacto }}</p>
      <p><strong>Estado:</strong> {{ proveedorDetalle.estado }}</p>
      <p><strong>Certificaciones vigentes:</strong>
      @if (proveedorDetalle.certificacionesVigentes && proveedorDetalle.certificacionesVigentes.length) {
        <span>
          @for (cert of proveedorDetalle.certificacionesVigentes; track cert; let last = $last) {
            <span>
              {{ cert }}@if (!last) {
              <span>, </span>
            }
          </span>
        }
      </span>
    } @else {
      Sin certificaciones
    }
  </p>
</div>
}
</div>
</div>
