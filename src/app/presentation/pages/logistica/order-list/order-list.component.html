<div class="order-list-container">
  <!-- Header -->
  <div class="page-header">
    <h1>
      <mat-icon>shopping_cart</mat-icon>
      Listado de Órdenes
    </h1>
    <p class="subtitle">Gestiona y consulta todas las órdenes de la compañía</p>
  </div>

  <!-- Sección de Filtros -->
  <mat-card class="filters-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>filter_list</mat-icon>
        Filtros
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="filters-grid">
        <!-- Filtro de Estado -->
        <mat-form-field appearance="outline">
          <mat-label>Estado</mat-label>
          <mat-select 
            [(ngModel)]="filterStatus" 
            (ngModelChange)="onFilterChange()">
            @for (option of statusOptions; track option.value) {
              <mat-option [value]="option.value">{{ option.label }}</mat-option>
            }
          </mat-select>
          <mat-icon matPrefix>inventory</mat-icon>
        </mat-form-field>

        <!-- Filtro Fecha Orden Desde -->
        <mat-form-field appearance="outline">
          <mat-label>Fecha Orden Desde</mat-label>
          <input 
            matInput 
            type="date" 
            [(ngModel)]="filterOrderDateFrom"
            (ngModelChange)="onFilterChange()">
          <mat-icon matPrefix>calendar_today</mat-icon>
        </mat-form-field>

        <!-- Filtro Fecha Orden Hasta -->
        <mat-form-field appearance="outline">
          <mat-label>Fecha Orden Hasta</mat-label>
          <input 
            matInput 
            type="date" 
            [(ngModel)]="filterOrderDateTo"
            (ngModelChange)="onFilterChange()">
          <mat-icon matPrefix>calendar_today</mat-icon>
        </mat-form-field>

        <!-- Filtro Fecha Entrega Desde -->
        <mat-form-field appearance="outline">
          <mat-label>Fecha Entrega Desde</mat-label>
          <input 
            matInput 
            type="date" 
            [(ngModel)]="filterDeliveryDateFrom"
            (ngModelChange)="onFilterChange()">
          <mat-icon matPrefix>local_shipping</mat-icon>
        </mat-form-field>

        <!-- Filtro Fecha Entrega Hasta -->
        <mat-form-field appearance="outline">
          <mat-label>Fecha Entrega Hasta</mat-label>
          <input 
            matInput 
            type="date" 
            [(ngModel)]="filterDeliveryDateTo"
            (ngModelChange)="onFilterChange()">
          <mat-icon matPrefix>local_shipping</mat-icon>
        </mat-form-field>
      </div>

      @if (hasActiveFilters()) {
        <div class="filters-actions">
          <button 
            mat-raised-button 
            color="accent" 
            (click)="clearFilters()">
            <mat-icon>clear</mat-icon>
            Limpiar Filtros
          </button>
        </div>
      }
    </mat-card-content>
  </mat-card>

  <!-- Resumen -->
  <div class="summary-section">
    <div class="summary-info">
      <mat-icon>info</mat-icon>
      <span>
        Mostrando <strong>{{ orders().length }}</strong> de 
        <strong>{{ totalOrders() }}</strong> órdenes
      </span>
    </div>
  </div>

  <!-- Estado de carga -->
  @if (loading()) {
    <div class="loading-container">
      <mat-spinner diameter="50"></mat-spinner>
      <p>Cargando órdenes...</p>
    </div>
  }

  <!-- Estado de error -->
  @if (error() && !loading()) {
    <mat-card class="error-card">
      <mat-card-content>
        <div class="error-content">
          <mat-icon color="warn">error</mat-icon>
          <p>{{ error() }}</p>
          <button mat-raised-button color="primary" (click)="retry()">
            <mat-icon>refresh</mat-icon>
            Reintentar
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  }

  <!-- Tabla de Órdenes -->
  @if (!loading() && !error()) {
    <mat-card class="table-card">
      <mat-card-content>
        <div class="table-container">
          <table mat-table [dataSource]="orders()" class="orders-table">
            
            <!-- Columna: Número de Orden -->
            <ng-container matColumnDef="orderNumber">
              <th mat-header-cell *matHeaderCellDef>Número de Orden</th>
              <td mat-cell *matCellDef="let order">
                <strong class="order-number">{{ order.orderNumber }}</strong>
              </td>
            </ng-container>

            <!-- Columna: Cliente -->
            <ng-container matColumnDef="customer">
              <th mat-header-cell *matHeaderCellDef>Cliente</th>
              <td mat-cell *matCellDef="let order">
                <div class="customer-info">
                  <div class="customer-name">{{ order.customer.businessName }}</div>
                  <div class="customer-doc">{{ order.customer.documentNumber }}</div>
                </div>
              </td>
            </ng-container>

            <!-- Columna: Estado -->
            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef>Estado</th>
              <td mat-cell *matCellDef="let order">
                <mat-chip [class]="getStatusBadgeClass(order.status)">
                  {{ getStatusLabel(order.status) }}
                </mat-chip>
              </td>
            </ng-container>

            <!-- Columna: Fecha Orden -->
            <ng-container matColumnDef="orderDate">
              <th mat-header-cell *matHeaderCellDef>Fecha Orden</th>
              <td mat-cell *matCellDef="let order">
                {{ formatDate(order.orderDate) }}
              </td>
            </ng-container>

            <!-- Columna: Fecha Entrega -->
            <ng-container matColumnDef="deliveryDate">
              <th mat-header-cell *matHeaderCellDef>Fecha Entrega</th>
              <td mat-cell *matCellDef="let order">
                {{ formatDateOnly(order.deliveryDate) }}
              </td>
            </ng-container>

            <!-- Columna: Ciudad -->
            <ng-container matColumnDef="deliveryCity">
              <th mat-header-cell *matHeaderCellDef>Ciudad</th>
              <td mat-cell *matCellDef="let order">
                {{ order.deliveryCity || '-' }}
              </td>
            </ng-container>

            <!-- Columna: Total -->
            <ng-container matColumnDef="totalAmount">
              <th mat-header-cell *matHeaderCellDef>Total</th>
              <td mat-cell *matCellDef="let order" class="amount-cell">
                <strong>{{ formatCurrency(order.totalAmount) }}</strong>
              </td>
            </ng-container>

            <!-- Columna: Acciones -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef>Acciones</th>
              <td mat-cell *matCellDef="let order">
                <button 
                  mat-icon-button 
                  color="primary"
                  matTooltip="Ver detalle"
                  [routerLink]="['/ordenes', order.id]">
                  <mat-icon>visibility</mat-icon>
                </button>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

            <!-- Fila cuando no hay datos -->
            @if (orders().length === 0) {
              <tr class="mat-row no-data-row">
                <td class="mat-cell no-data-cell" [attr.colspan]="displayedColumns.length">
                  <div class="no-data-content">
                    <mat-icon>inbox</mat-icon>
                    <p>No se encontraron órdenes</p>
                  </div>
                </td>
              </tr>
            }
          </table>
        </div>

        <!-- Paginación -->
        <mat-paginator 
          [length]="totalOrders()"
          [pageSize]="perPage()"
          [pageIndex]="currentPage() - 1"
          [pageSizeOptions]="pageSizeOptions"
          (page)="onPageChange($event)"
          showFirstLastButtons>
        </mat-paginator>
      </mat-card-content>
    </mat-card>
  }
</div>
