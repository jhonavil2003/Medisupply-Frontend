<div class="container">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
    <div style="display: flex; align-items: center; gap: 16px;">
      <a mat-icon-button [routerLink]="['/dashboard-admin']">
        <mat-icon>arrow_back</mat-icon>
      </a>
      <h2 style="margin: 0;">{{ 'LOGISTICS.ROUTE.TITLE' | translate }}</h2>
    </div>
    <button mat-raised-button color="primary" routerLink="/logistica/generar-rutas">
      <mat-icon>add</mat-icon>
      {{ 'LOGISTICS.ROUTE.GENERATE_NEW_ROUTE' | translate }}
    </button>
  </div>

  <!-- Filtros -->
  <div class="filters-row">
    <mat-form-field appearance="outline" floatLabel="always">
      <mat-label>{{ 'LOGISTICS.ROUTE.FILTERS.PLANNED_DATE' | translate }}</mat-label>
      <input matInput [matDatepicker]="picker" [(ngModel)]="plannedDate" (dateChange)="onFilterChange()">
      <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
      <mat-datepicker #picker></mat-datepicker>
    </mat-form-field>

    <mat-form-field appearance="outline" floatLabel="always">
      <mat-label>{{ 'LOGISTICS.ROUTE.FILTERS.STATUS' | translate }}</mat-label>
      <mat-select [(ngModel)]="selectedStatus" (selectionChange)="onFilterChange()">
        <mat-option value="">{{ 'COMMON.ALL' | translate }}</mat-option>
        @for (status of statusOptions; track status.value) {
          <mat-option [value]="status.value">{{ status.labelKey | translate }}</mat-option>
        }
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline" floatLabel="always">
      <mat-label>{{ 'LOGISTICS.ROUTE.FILTERS.VEHICLE_ID' | translate }}</mat-label>
      <input matInput type="number" [(ngModel)]="selectedVehicleId" (ngModelChange)="onFilterChange()" [placeholder]="'LOGISTICS.ROUTE.FILTERS.ENTER_ID' | translate">
    </mat-form-field>
  </div>

  <div class="filter-actions">
    <button mat-button type="button" (click)="clearFilters()">
      <mat-icon>filter_list</mat-icon>
      {{ 'LOGISTICS.ROUTE.FILTERS.CLEAR_FILTERS' | translate }}
    </button>
  </div>
</div>

<!-- Loading Spinner -->
<mat-progress-bar *ngIf="loading()" mode="indeterminate"></mat-progress-bar>

<!-- Tabla de Rutas -->
@if (!loading()) {
  <div class="table-container">
    @if (routes().length === 0) {
      <div class="no-results-message">
        <mat-icon>route</mat-icon>
        <h2>{{ 'LOGISTICS.ROUTE.NO_ROUTES_FOUND' | translate }}</h2>
        <p>{{ 'LOGISTICS.ROUTE.NO_ROUTES_WITH_FILTERS' | translate }}</p>
      </div>
    } @else {
      <mat-card>
        <mat-card-content>
          <table mat-table [dataSource]="routes()" class="routes-table">
          
          <!-- Route Number Column -->
            <ng-container matColumnDef="routeNumber">
              <th mat-header-cell *matHeaderCellDef>{{ 'LOGISTICS.ROUTE.TABLE.ROUTE_NUMBER' | translate }}</th>
              <td mat-cell *matCellDef="let route">
                <strong>{{ route.routeCode }}</strong>
              </td>
            </ng-container>

            <!-- Planned Date Column -->
            <ng-container matColumnDef="plannedDate">
              <th mat-header-cell *matHeaderCellDef>{{ 'LOGISTICS.ROUTE.TABLE.PLANNED_DATE' | translate }}</th>
              <td mat-cell *matCellDef="let route">
                {{ route.dates.plannedDate }}
              </td>
            </ng-container>

            <!-- Status Column -->
            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef>{{ 'LOGISTICS.ROUTE.TABLE.STATUS' | translate }}</th>
              <td mat-cell *matCellDef="let route">
                <mat-chip [color]="getStatusColor(route.status)">
                  {{ getStatusLabel(route.status) }}
                </mat-chip>
              </td>
            </ng-container>

            <!-- Vehicle Column -->
            <ng-container matColumnDef="vehicle">
              <th mat-header-cell *matHeaderCellDef>{{ 'LOGISTICS.ROUTE.TABLE.VEHICLE' | translate }}</th>
              <td mat-cell *matCellDef="let route">
                <div class="vehicle-info">
                  <div><strong>{{ route.vehicle.plate }}</strong></div>
                  <div class="secondary-text">{{ route.vehicle.vehicleType }}</div>
                </div>
              </td>
            </ng-container>

            <!-- Driver Column -->
            <ng-container matColumnDef="driver">
              <th mat-header-cell *matHeaderCellDef>{{ 'LOGISTICS.ROUTE.TABLE.DRIVER' | translate }}</th>
              <td mat-cell *matCellDef="let route">
                <div class="driver-info">
                  <div>{{ route.driver.name }}</div>
                  <div class="secondary-text">{{ route.driver.phone }}</div>
                </div>
              </td>
            </ng-container>

            <!-- Stops Column -->
            <ng-container matColumnDef="stops">
              <th mat-header-cell *matHeaderCellDef>{{ 'LOGISTICS.ROUTE.TABLE.STOPS' | translate }}</th>
              <td mat-cell *matCellDef="let route">
                <div class="stops-info">
                  <div><strong>{{ route.metrics.totalStops }}</strong> {{ 'LOGISTICS.ROUTE.TABLE.STOPS_UNIT' | translate }}</div>
                  <div class="secondary-text">
                    {{ route.metrics.completionPercentage }}% {{ 'LOGISTICS.ROUTE.TABLE.COMPLETED' | translate }}
                  </div>
                </div>
              </td>
            </ng-container>

            <!-- Metrics Column -->
            <ng-container matColumnDef="metrics">
              <th mat-header-cell *matHeaderCellDef>{{ 'LOGISTICS.ROUTE.TABLE.METRICS' | translate }}</th>
              <td mat-cell *matCellDef="let route">
                <div class="metrics-info">
                  <div>
                    <mat-icon class="small-icon">straighten</mat-icon>
                    {{ route.metrics.totalDistanceKm }} km
                  </div>
                  <div>
                    <mat-icon class="small-icon">schedule</mat-icon>
                    {{ formatDuration(route.metrics.estimatedDurationMinutes) }}
                  </div>
                </div>
              </td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef>{{ 'LOGISTICS.ROUTE.TABLE.ACTIONS' | translate }}</th>
              <td mat-cell *matCellDef="let route">
                <div class="actions-buttons">
                  <button mat-icon-button color="primary" 
                          (click)="viewRoute(route)"
                          [matTooltip]="'LOGISTICS.ROUTE.ACTIONS.VIEW_DETAILS' | translate">
                    <mat-icon>visibility</mat-icon>
                  </button>
                  <button mat-icon-button color="accent" 
                          (click)="viewOnMap(route)"
                          [matTooltip]="'LOGISTICS.ROUTE.ACTIONS.VIEW_ON_MAP' | translate">
                    <mat-icon>map</mat-icon>
                  </button>
                  @if (canActivateRoute(route)) {
                    <button mat-icon-button 
                            color="primary" 
                            (click)="activateRoute(route, $event)"
                            [matTooltip]="'LOGISTICS.ROUTE.ACTIONS.ACTIVATE_ROUTE' | translate"
                            class="activate-button">
                      <mat-icon>check_circle</mat-icon>
                    </button>
                  }
                </div>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
          </table>

          <!-- Paginador -->
          <mat-paginator 
            [length]="total()"
            [pageSize]="perPage()"
            [pageIndex]="page() - 1"
            [pageSizeOptions]="[5, 10, 25, 50]"
            (page)="onPageChange($event)"
            showFirstLastButtons
            class="unified-paginator">
          </mat-paginator>
        </mat-card-content>
      </mat-card>
    }
  </div>
}
