<div class="container">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
    <div style="display: flex; align-items: center; gap: 16px;">
      <a mat-icon-button [routerLink]="['/dashboard-admin']">
        <mat-icon>arrow_back</mat-icon>
      </a>
      <h2 style="margin: 0;">{{ 'CONFIRM_ORDERS.TITLE' | translate }}</h2>
    </div>

    @if (hasSelectedOrders()) {
      <button 
        mat-raised-button 
        color="primary" 
        (click)="confirmSelectedOrders()"
        [disabled]="loading()">
        <mat-icon>check_circle</mat-icon>
        {{ 'CONFIRM_ORDERS.CONFIRM_SELECTED' | translate }} ({{ selectedCount() }})
      </button>
    }
  </div>

  <div class="totales-resumen">
    <div class="total-item">
      <mat-icon>pending_actions</mat-icon>
      <div>
        <span class="total-label">{{ 'CONFIRM_ORDERS.PREPARED_ORDERS' | translate }}</span>
        <span class="total-value">{{ totalOrders() }}</span>
      </div>
    </div>
  </div>
</div>

@if (loading() && orders().length === 0) {
    <div class="loading-container">
      <mat-spinner diameter="50"></mat-spinner>
      <p>{{ 'CONFIRM_ORDERS.LOADING' | translate }}</p>
    </div>
  }

  @if (error() && !loading()) {
    <mat-card class="error-card">
      <mat-card-content>
        <div class="error-content">
          <mat-icon color="warn">error</mat-icon>
          <h2>{{ 'CONFIRM_ORDERS.ERROR_LOADING' | translate }}</h2>
          <p>{{ error() | translate }}</p>
          <button mat-raised-button color="primary" (click)="retry()">
            <mat-icon>refresh</mat-icon>
            {{ 'CONFIRM_ORDERS.RETRY' | translate }}
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  }

@if (!loading() && !error() && orders().length === 0) {
  <div class="container">
    <div class="no-results-message">
      <mat-icon>check_circle_outline</mat-icon>
      <h2>{{ 'CONFIRM_ORDERS.NO_PREPARED_ORDERS' | translate }}</h2>
      <p>{{ 'CONFIRM_ORDERS.NO_PREPARED_ORDERS_DESC' | translate }}</p>
      <button mat-raised-button color="primary" (click)="retry()">
        <mat-icon style="font-size: 20px; width: 20px; height: 20px;">refresh</mat-icon>
        {{ 'CONFIRM_ORDERS.UPDATE' | translate }}
      </button>
    </div>
  </div>
}

  @if (orders().length > 0) {
    <mat-card class="table-card">
      <div class="table-container">
        <table mat-table [dataSource]="orders()" class="orders-table">
          <ng-container matColumnDef="select">
            <th mat-header-cell *matHeaderCellDef>
              <mat-checkbox
                (change)="$event ? toggleAllRows() : null"
                [checked]="selection.hasValue() && isAllSelected()"
                [indeterminate]="selection.hasValue() && !isAllSelected()">
              </mat-checkbox>
            </th>
            <td mat-cell *matCellDef="let order">
              <mat-checkbox
                (click)="$event.stopPropagation()"
                (change)="$event ? selection.toggle(order) : null"
                [checked]="selection.isSelected(order)">
              </mat-checkbox>
            </td>
          </ng-container>

          <ng-container matColumnDef="orderNumber">
            <th mat-header-cell *matHeaderCellDef>{{ 'CONFIRM_ORDERS.TABLE.ORDER_NUMBER' | translate }}</th>
            <td mat-cell *matCellDef="let order">
              <div class="order-number">
                <mat-icon class="order-icon">shopping_cart</mat-icon>
                <a [routerLink]="['/ordenes', order.id]" class="order-link">
                  {{ order.orderNumber }}
                </a>
              </div>
            </td>
          </ng-container>

          <ng-container matColumnDef="customer">
            <th mat-header-cell *matHeaderCellDef>{{ 'CONFIRM_ORDERS.TABLE.CUSTOMER' | translate }}</th>
            <td mat-cell *matCellDef="let order">
              <div class="customer-info">
                <strong>{{ order.customer.businessName }}</strong>
                <span class="document">{{ order.customer.documentNumber }}</span>
              </div>
            </td>
          </ng-container>

          <ng-container matColumnDef="orderDate">
            <th mat-header-cell *matHeaderCellDef>{{ 'CONFIRM_ORDERS.TABLE.ORDER_DATE' | translate }}</th>
            <td mat-cell *matCellDef="let order">
              <div class="date-info">
                <mat-icon>event</mat-icon>
                {{ formatDate(order.orderDate) }}
              </div>
            </td>
          </ng-container>

          <ng-container matColumnDef="deliveryDate">
            <th mat-header-cell *matHeaderCellDef>{{ 'CONFIRM_ORDERS.TABLE.DELIVERY_DATE' | translate }}</th>
            <td mat-cell *matCellDef="let order">
              @if (order.deliveryDate) {
                <div class="date-info delivery">
                  <mat-icon>local_shipping</mat-icon>
                  {{ formatDate(order.deliveryDate) }}
                </div>
              } @else {
                <span class="no-data">{{ 'CONFIRM_ORDERS.NO_DATE_SPECIFIED' | translate }}</span>
              }
            </td>
          </ng-container>

          <ng-container matColumnDef="totalAmount">
            <th mat-header-cell *matHeaderCellDef>{{ 'CONFIRM_ORDERS.TABLE.TOTAL' | translate }}</th>
            <td mat-cell *matCellDef="let order">
              <strong class="amount">{{ formatCurrency(order.totalAmount) }}</strong>
            </td>
          </ng-container>

          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef class="actions-header">{{ 'CONFIRM_ORDERS.TABLE.ACTIONS' | translate }}</th>
            <td mat-cell *matCellDef="let order" class="actions-cell">
              <div class="actions-buttons">
                <button
                  mat-icon-button
                  color="accent"
                  (click)="viewOrderDetail(order)"
                  [matTooltip]="'CONFIRM_ORDERS.TABLE.VIEW_DETAIL' | translate"
                  class="detail-btn">
                  <mat-icon>visibility</mat-icon>
                </button>
                
                @if (isConfirming(order.id)) {
                  <button
                    mat-raised-button
                    color="primary"
                    disabled
                    class="confirm-btn">
                    <mat-spinner diameter="20"></mat-spinner>
                  </button>
                } @else {
                  <button
                    mat-raised-button
                    color="primary"
                    (click)="confirmSingleOrder(order)"
                    [matTooltip]="'CONFIRM_ORDERS.TABLE.CONFIRM_ORDER' | translate"
                    class="confirm-btn">
                    <mat-icon>check_circle</mat-icon>
                    <span>{{ 'CONFIRM_ORDERS.CONFIRM' | translate }}</span>
                  </button>
                }
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="order-row"></tr>
        </table>
      </div>

      <mat-paginator
        [length]="totalOrders()"
        [pageSize]="pageSize()"
        [pageIndex]="currentPage() - 1"
        [pageSizeOptions]="[5, 10, 25, 50]"
        (page)="onPageChange($event)"
        showFirstLastButtons>
      </mat-paginator>
    </mat-card>
  }
