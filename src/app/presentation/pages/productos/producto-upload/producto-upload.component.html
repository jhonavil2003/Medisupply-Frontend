<div class="container">
  <!-- Header -->
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
    <div style="display: flex; align-items: center; gap: 16px;">
      <a mat-icon-button [routerLink]="['/dashboard-admin']">
        <mat-icon>arrow_back</mat-icon>
      </a>
      <h2 style="margin: 0;">{{ 'BULK_UPLOAD.TITLE' | translate }}</h2>
    </div>
    <div class="header-actions">
      <button mat-raised-button color="accent" (click)="descargarPlantilla()">
        <mat-icon>download</mat-icon>
        {{ 'BULK_UPLOAD.ACTIONS.DOWNLOAD_TEMPLATE' | translate }}
      </button>
      <a mat-raised-button [routerLink]="['/productos/upload/historial']">
        <mat-icon>history</mat-icon>
        {{ 'BULK_UPLOAD.ACTIONS.VIEW_HISTORY' | translate }}
      </a>
    </div>
  </div>

  <!-- Instrucciones -->
  @if (!jobActual()) {
    <mat-card class="info-card">
      <mat-card-content>
        <div class="info-content">
          <mat-icon class="info-icon">info</mat-icon>
          <div>
            <h3>{{ 'BULK_UPLOAD.INSTRUCTIONS.TITLE' | translate }}</h3>
            <ol>
              <li>{{ 'BULK_UPLOAD.INSTRUCTIONS.STEP_1' | translate }}</li>
              <li>{{ 'BULK_UPLOAD.INSTRUCTIONS.STEP_2' | translate }}</li>
              <li>{{ 'BULK_UPLOAD.INSTRUCTIONS.STEP_3' | translate }}</li>
              <li>{{ 'BULK_UPLOAD.INSTRUCTIONS.STEP_4' | translate }}</li>
              <li>{{ 'BULK_UPLOAD.INSTRUCTIONS.STEP_5' | translate }}</li>
            </ol>
            <p><strong>{{ 'BULK_UPLOAD.INSTRUCTIONS.LIMITS_LABEL' | translate }}</strong> {{ 'BULK_UPLOAD.INSTRUCTIONS.LIMITS_TEXT' | translate }}</p>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  }

  <!-- Área de carga -->
  @if (!jobActual() && !cargando()) {
    <mat-card class="upload-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>cloud_upload</mat-icon>
          {{ 'BULK_UPLOAD.UPLOAD.SELECT_FILE' | translate }}
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="upload-box"
          (dragover)="onDragOver($event)"
          (drop)="onFileDrop($event)">
          <mat-icon class="upload-icon">description</mat-icon>
          <p>{{ 'BULK_UPLOAD.UPLOAD.DRAG_DROP_TEXT' | translate }}</p>
          <input type="file" id="fileInput" (change)="onFileSelected($event)" accept=".csv" hidden />
          <label for="fileInput" class="btn-outline">
            <mat-icon>folder_open</mat-icon>
            {{ 'BULK_UPLOAD.UPLOAD.SELECT_FILE_BUTTON' | translate }}
          </label>

          @if (archivoSeleccionado()) {
            <div class="file-info">
              <mat-icon class="success-icon">check_circle</mat-icon>
              <span>{{ archivoSeleccionado()!.name }}</span>
              <span class="file-size">({{ (archivoSeleccionado()!.size / 1024 / 1024).toFixed(2) }} MB)</span>
            </div>
          }
        </div>

        @if (archivoValido()) {
          <div class="actions">
            <button mat-raised-button color="primary" (click)="procesarArchivo()">
              <mat-icon>upload</mat-icon>
              {{ 'BULK_UPLOAD.UPLOAD.UPLOAD_TO_DATABASE' | translate }}
            </button>
          </div>
        }
      </mat-card-content>
    </mat-card>
  }

  <!-- Progreso del Job -->
  @if (jobActual(); as job) {
    <mat-card class="progress-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>{{ getStatusIcon(job.status) }}</mat-icon>
          {{ 'BULK_UPLOAD.PROGRESS.UPLOAD_STATUS' | translate }}
        </mat-card-title>
        <mat-chip [class]="getStatusColor(job.status)">
          {{ getStatusText(job.status) }}
        </mat-chip>
      </mat-card-header>

      <mat-card-content>
        <!-- Información del archivo -->
        <div class="job-info">
          <div class="info-item">
            <mat-icon>description</mat-icon>
            <div>
              <span class="label">{{ 'BULK_UPLOAD.PROGRESS.FILE' | translate }}:</span>
              <span class="value">{{ job.filename }}</span>
            </div>
          </div>
          <div class="info-item">
            <mat-icon>event</mat-icon>
            <div>
              <span class="label">{{ 'BULK_UPLOAD.PROGRESS.STARTED' | translate }}:</span>
              <span class="value">{{ job.created_at | date:'dd/MM/yyyy HH:mm' }}</span>
            </div>
          </div>
        </div>

        <!-- Barra de progreso -->
        <div class="progress-section">
          <div class="progress-header">
            <span>{{ 'BULK_UPLOAD.PROGRESS.PROGRESS_LABEL' | translate }}: {{ job.progress_percentage.toFixed(1) }}%</span>
            <span>{{ job.processed_rows }} / {{ job.total_rows }} {{ 'BULK_UPLOAD.PROGRESS.ROWS' | translate }}</span>
          </div>
          <mat-progress-bar 
            mode="determinate" 
            [value]="job.progress_percentage"
            [color]="job.status === 'failed' ? 'warn' : 'primary'">
          </mat-progress-bar>
        </div>

        <!-- Métricas -->
        <div class="metrics-grid">
          <div class="metric-card success">
            <mat-icon>check_circle</mat-icon>
            <div>
              <div class="metric-value">{{ job.successful_rows }}</div>
              <div class="metric-label">{{ 'BULK_UPLOAD.METRICS.SUCCESSFUL' | translate }}</div>
            </div>
          </div>

          <div class="metric-card error">
            <mat-icon>error</mat-icon>
            <div>
              <div class="metric-value">{{ job.failed_rows }}</div>
              <div class="metric-label">{{ 'BULK_UPLOAD.METRICS.FAILED' | translate }}</div>
            </div>
          </div>

          <div class="metric-card total">
            <mat-icon>inventory</mat-icon>
            <div>
              <div class="metric-value">{{ job.total_rows }}</div>
              <div class="metric-label">{{ 'BULK_UPLOAD.METRICS.TOTAL' | translate }}</div>
            </div>
          </div>

          <div class="metric-card rate">
            <mat-icon>trending_up</mat-icon>
            <div>
              <div class="metric-value">{{ job.success_rate.toFixed(1) }}%</div>
              <div class="metric-label">{{ 'BULK_UPLOAD.METRICS.SUCCESS_RATE' | translate }}</div>
            </div>
          </div>
        </div>

        <!-- Tiempo estimado -->
        @if (job.estimated_time_remaining && job.status === 'processing') {
          <div class="time-remaining">
            <mat-icon>timer</mat-icon>
            <span>{{ 'BULK_UPLOAD.PROGRESS.ESTIMATED_TIME_REMAINING' | translate }}: {{ job.estimated_time_remaining.toFixed(0) }} {{ 'BULK_UPLOAD.PROGRESS.SECONDS' | translate }}</span>
          </div>
        }

        <!-- Mensaje de error -->
        @if (job.error_message) {
          <div class="error-message">
            <mat-icon>warning</mat-icon>
            <span>{{ job.error_message }}</span>
          </div>
        }

        <!-- Acciones -->
        <div class="job-actions">
          @if (job.status === 'completed' && job.failed_rows > 0) {
            <button mat-raised-button color="warn" (click)="descargarErrores()">
              <mat-icon>download</mat-icon>
              {{ 'BULK_UPLOAD.ACTIONS.DOWNLOAD_ERRORS' | translate }}
            </button>
          }

          @if (job.status === 'pending' || job.status === 'validating') {
            <button mat-raised-button color="warn" (click)="cancelarJob()">
              <mat-icon>cancel</mat-icon>
              {{ 'BULK_UPLOAD.ACTIONS.CANCEL_PROCESS' | translate }}
            </button>
          }

          @if (job.status === 'completed' || job.status === 'failed' || job.status === 'cancelled') {
            <button mat-raised-button color="primary" (click)="reiniciar()">
              <mat-icon>refresh</mat-icon>
              {{ 'BULK_UPLOAD.ACTIONS.UPLOAD_ANOTHER_FILE' | translate }}
            </button>
          }
        </div>
      </mat-card-content>
    </mat-card>
  }
</div>
