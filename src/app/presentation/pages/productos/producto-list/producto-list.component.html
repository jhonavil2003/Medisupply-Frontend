<div class="container">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
    <div style="display: flex; align-items: center; gap: 16px;">
      <a mat-icon-button [routerLink]="['/dashboard-admin']" data-cy="back-to-dashboard">
        <mat-icon>arrow_back</mat-icon>
      </a>
      <h2 style="margin: 0;">{{ 'PRODUCTS.LIST_TITLE' | translate }}</h2>
    </div>
    <button mat-raised-button color="primary" (click)="navigateToCreate()" [attr.aria-label]="'PRODUCTS.CREATE_TITLE' | translate" data-cy="create-product-button">
      <mat-icon>add</mat-icon> {{ 'PRODUCTS.CREATE_BUTTON' | translate }}
    </button>
  </div>
  
  <div class="search-bar" style="flex: 1;">
    <div class="search-wrap">
      <mat-form-field appearance="outline" class="search-field">
        <mat-label>{{ 'PRODUCTS.SEARCH_PRODUCTS' | translate }}</mat-label>
        <input matInput
          [placeholder]="'PRODUCTS.SEARCH_PLACEHOLDER' | translate"
          [formControl]="searchControl"
          data-cy="product-search-input"
          />
        @if (searchControl.value) {
          <button
            matSuffix
            mat-icon-button
            [attr.aria-label]="'COMMON.CLEAR_FILTERS' | translate"
            (click)="searchControl.setValue('')" color="primary"
            data-cy="clear-search">
            <mat-icon>close</mat-icon>
          </button>
        }
        <mat-icon matPrefix>search</mat-icon>
      </mat-form-field>
    </div>
  </div>

  <!-- Filtros -->
  <form [formGroup]="filterForm">
    <div class="filters-row">
      <mat-form-field appearance="outline" floatLabel="always">
        <mat-label>{{ 'PRODUCTS.CATEGORY' | translate }}</mat-label>
            <mat-select formControlName="category" (selectionChange)="onFilterChange()" data-cy="filter-category">
              <mat-option value="">{{ 'COMMON.ALL' | translate }}</mat-option>
              <mat-option *ngFor="let cat of categories" [value]="cat">
                {{ cat }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" floatLabel="always">
            <mat-label>{{ 'PRODUCTS.SUBCATEGORY' | translate }}</mat-label>
            <input matInput formControlName="subcategory" (change)="onFilterChange()" data-cy="filter-subcategory">
          </mat-form-field>

          <mat-form-field appearance="outline" floatLabel="always">
            <mat-label>{{ 'PRODUCTS.COLD_CHAIN' | translate }}</mat-label>
            <mat-select formControlName="requires_cold_chain" (selectionChange)="onFilterChange()" data-cy="filter-cold-chain">
              <mat-option [value]="null">{{ 'COMMON.ALL' | translate }}</mat-option>
              <mat-option [value]="true">{{ 'COMMON.YES' | translate }} ❄️</mat-option>
              <mat-option [value]="false">{{ 'COMMON.NO' | translate }}</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div class="filter-actions">
          <button mat-button type="button" (click)="resetFilters()" data-cy="clear-filters">
            <mat-icon>filter_list</mat-icon>
            {{ 'COMMON.CLEAR_FILTERS' | translate }}
          </button>
        </div>
      </form>
</div>

<!-- Loading Spinner -->
<mat-progress-bar *ngIf="loading()" mode="indeterminate"></mat-progress-bar>

<!-- Error Message -->
<mat-card *ngIf="errorMessage()" class="error-card">
    <mat-icon color="warn">error</mat-icon>
    <p>{{ errorMessage() }}</p>
  </mat-card>

<!-- Tabla de Productos -->
<div class="container">
  <div *ngIf="products().length > 0 && !loading()" class="table-container">
    <table mat-table [dataSource]="dataSource" matSort class="modern-table products-table">
          
          <!-- SKU Column -->
          <ng-container matColumnDef="sku">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>SKU</th>
            <td mat-cell *matCellDef="let product">{{ product.sku }}</td>
          </ng-container>

          <!-- Name Column -->
          <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>{{ 'PRODUCTS.NAME' | translate }}</th>
            <td mat-cell *matCellDef="let product">
              <div class="product-name">
                <span>{{ getColdChainIcon(product) }} {{ getPrescriptionIcon(product) }}</span>
                <span>{{ product.name }}</span>
                <small *ngIf="product.description">{{ product.description }}</small>
              </div>
            </td>
          </ng-container>

          <!-- Category Column -->
          <ng-container matColumnDef="category">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>{{ 'PRODUCTS.CATEGORY' | translate }}</th>
            <td mat-cell *matCellDef="let product">
              {{ product.category }}
              <span *ngIf="product.subcategory">/ {{ product.subcategory }}</span>
            </td>
          </ng-container>

          <!-- Supplier Column -->
          <ng-container matColumnDef="supplier_name">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>{{ 'PRODUCTS.SUPPLIER' | translate }}</th>
            <td mat-cell *matCellDef="let product">{{ product.supplier_name || 'N/A' }}</td>
          </ng-container>

          <!-- Price Column -->
          <ng-container matColumnDef="unit_price">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>{{ 'PRODUCTS.PRICE' | translate }}</th>
            <td mat-cell *matCellDef="let product">
              <div class="price-cell">
                <span class="price">{{ product.currency }} {{ product.unit_price | number:'1.2-2' }}</span>
                <small>/ {{ product.unit_of_measure }}</small>
              </div>
            </td>
          </ng-container>

          <!-- Cold Chain Column -->
          <ng-container matColumnDef="cold_chain">
            <th mat-header-cell *matHeaderCellDef>{{ 'PRODUCTS.COLD_CHAIN' | translate }}</th>
            <td mat-cell *matCellDef="let product">
              <mat-icon *ngIf="product.requires_cold_chain" color="primary" class="cold-icon">ac_unit</mat-icon>
              <span *ngIf="getTemperatureRange(product)" class="temp-range">
                {{ getTemperatureRange(product) }}
              </span>
            </td>
          </ng-container>

          <!-- Active Column -->
          <ng-container matColumnDef="is_active">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>{{ 'PRODUCTS.STATUS' | translate }}</th>
            <td mat-cell *matCellDef="let product">
              <span [style.color]="product.is_active ? '#2e7d32' : '#d32f2f'">
                {{ (product.is_active ? 'COMMON.ACTIVE' : 'COMMON.INACTIVE') | translate }}
              </span>
            </td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="acciones">
            <th mat-header-cell *matHeaderCellDef>{{ 'COMMON.ACTIONS' | translate }}</th>
            <td mat-cell *matCellDef="let product" class="actions">
              <button class="btn-icon" [title]="'COMMON.VIEW' | translate" (click)="verDetalle(product)" data-cy="view-product"><i class="fas fa-eye"></i></button>
              <button class="btn-icon" [title]="'COMMON.EDIT' | translate" (click)="editarProducto(product)" data-cy="edit-product"><i class="fas fa-edit"></i></button>
              <button class="btn-icon danger" [title]="'COMMON.DELETE' | translate" (click)="eliminarProducto(product)" data-cy="delete-product"><i class="fas fa-trash"></i></button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>

      <!-- Paginación unificada -->
      <mat-paginator 
        class="unified-paginator"
        *ngIf="pagination()"
        [length]="pagination()?.total_items"
        [pageSize]="pagination()?.per_page"
        [pageIndex]="(pagination()?.page || 1) - 1"
        [pageSizeOptions]="[10, 20, 50, 100]"
        (page)="onPageChange($event)"
        showFirstLastButtons>
      </mat-paginator>
  </div>

  <!-- Sin Resultados -->
  <div *ngIf="products().length === 0 && !loading() && !errorMessage()" class="no-results-message" data-cy="no-results">
    <p>{{ 'COMMON.NO_RESULTS' | translate }}</p>
  </div>
</div>
