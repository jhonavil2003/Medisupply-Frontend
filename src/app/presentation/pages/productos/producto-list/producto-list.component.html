<div class="container">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
    <div style="display: flex; align-items: center; gap: 16px;">
      <a mat-icon-button [routerLink]="['/dashboard-admin']">
        <mat-icon>arrow_back</mat-icon>
      </a>
      <h2 style="margin: 0;">Gestión de productos</h2>
    </div>
    <button mat-raised-button color="primary" (click)="navigateToCreate()" aria-label="Crear producto">
      <mat-icon>add</mat-icon> Crear Producto
    </button>
  </div>
  
  <div class="search-bar" style="flex: 1;">
    <div class="search-wrap">
      <mat-form-field appearance="outline" class="search-field">
        <mat-label>Buscar productos</mat-label>
        <input matInput
          placeholder="Buscar por nombre, SKU, código de barras, fabricante..."
          [formControl]="searchControl"
          />
        @if (searchControl.value) {
          <button
            matSuffix
            mat-icon-button
            aria-label="Limpiar"
            (click)="searchControl.setValue('')" color="primary">
            <mat-icon>close</mat-icon>
          </button>
        }
      </mat-form-field>
    </div>
  </div>

  <!-- Filtros -->
  <form [formGroup]="filterForm">
    <div class="filters-row">
      <mat-form-field appearance="outline">
        <mat-label>Categoría</mat-label>
            <mat-select formControlName="category" (selectionChange)="onFilterChange()">
              <mat-option value="">Todas</mat-option>
              <mat-option *ngFor="let cat of categories" [value]="cat">
                {{ cat }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Subcategoría</mat-label>
            <input matInput formControlName="subcategory" (change)="onFilterChange()">
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Cadena de Frío</mat-label>
            <mat-select formControlName="requires_cold_chain" (selectionChange)="onFilterChange()">
              <mat-option [value]="null">Todos</mat-option>
              <mat-option [value]="true">Sí ❄️</mat-option>
              <mat-option [value]="false">No</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div class="filter-actions">
          <button mat-button type="button" (click)="resetFilters()">
            <mat-icon>clear_all</mat-icon>
            Limpiar
          </button>
        </div>
      </form>
</div>

<!-- Loading Spinner -->
<mat-progress-bar *ngIf="loading()" mode="indeterminate"></mat-progress-bar>

<!-- Error Message -->
<mat-card *ngIf="errorMessage()" class="error-card">
    <mat-icon color="warn">error</mat-icon>
    <p>{{ errorMessage() }}</p>
  </mat-card>

  <!-- Tabla de Productos -->
  <div *ngIf="products().length > 0 && !loading()" class="container">
    <div class="table-container">
      <table mat-table [dataSource]="dataSource" matSort class="modern-table products-table">
          
          <!-- SKU Column -->
          <ng-container matColumnDef="sku">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>SKU</th>
            <td mat-cell *matCellDef="let product">{{ product.sku }}</td>
          </ng-container>

          <!-- Name Column -->
          <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Producto</th>
            <td mat-cell *matCellDef="let product">
              <div class="product-name">
                <span>{{ getColdChainIcon(product) }} {{ getPrescriptionIcon(product) }}</span>
                <span>{{ product.name }}</span>
                <small *ngIf="product.description">{{ product.description }}</small>
              </div>
            </td>
          </ng-container>

          <!-- Category Column -->
          <ng-container matColumnDef="category">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Categoría</th>
            <td mat-cell *matCellDef="let product">
              {{ product.category }}
              <span *ngIf="product.subcategory">/ {{ product.subcategory }}</span>
            </td>
          </ng-container>

          <!-- Supplier Column -->
          <ng-container matColumnDef="supplier_name">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Proveedor</th>
            <td mat-cell *matCellDef="let product">{{ product.supplier_name || 'N/A' }}</td>
          </ng-container>

          <!-- Price Column -->
          <ng-container matColumnDef="unit_price">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Precio</th>
            <td mat-cell *matCellDef="let product">
              <div class="price-cell">
                <span class="price">{{ product.currency }} {{ product.unit_price | number:'1.2-2' }}</span>
                <small>/ {{ product.unit_of_measure }}</small>
              </div>
            </td>
          </ng-container>

          <!-- Cold Chain Column -->
          <ng-container matColumnDef="cold_chain">
            <th mat-header-cell *matHeaderCellDef>Cadena Frío</th>
            <td mat-cell *matCellDef="let product">
              <mat-icon *ngIf="product.requires_cold_chain" color="primary" class="cold-icon">ac_unit</mat-icon>
              <span *ngIf="getTemperatureRange(product)" class="temp-range">
                {{ getTemperatureRange(product) }}
              </span>
            </td>
          </ng-container>

          <!-- Active Column -->
          <ng-container matColumnDef="is_active">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Estado</th>
            <td mat-cell *matCellDef="let product">
              <span [class]="product.is_active ? 'status-active' : 'status-inactive'">
                {{ product.is_active ? 'Activo' : 'Inactivo' }}
              </span>
            </td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="acciones">
            <th mat-header-cell *matHeaderCellDef>Acciones</th>
            <td mat-cell *matCellDef="let product" class="actions">
              <button class="btn-icon" title="Ver" (click)="verDetalle(product)"><i class="fas fa-eye"></i></button>
              <button class="btn-icon" title="Editar" (click)="editarProducto(product)"><i class="fas fa-edit"></i></button>
              <button class="btn-icon danger" title="Eliminar" (click)="eliminarProducto(product)"><i class="fas fa-trash"></i></button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>
      </div>

      <!-- Paginación unificada -->
      <mat-paginator 
        class="unified-paginator"
        *ngIf="pagination()"
        [length]="pagination()?.total_items"
        [pageSize]="pagination()?.per_page"
        [pageIndex]="(pagination()?.page || 1) - 1"
        [pageSizeOptions]="[10, 20, 50, 100]"
        (page)="onPageChange($event)"
        showFirstLastButtons>
      </mat-paginator>
    </div>

  <!-- Sin Resultados -->
  <mat-card *ngIf="products().length === 0 && !loading() && !errorMessage()" class="no-results-card">
    <mat-icon>inventory</mat-icon>
    <h3>No se encontraron productos</h3>
    <p>Intenta ajustar los filtros de búsqueda</p>
    <button mat-raised-button color="primary" (click)="resetFilters()">
      Limpiar filtros
    </button>
  </mat-card>
