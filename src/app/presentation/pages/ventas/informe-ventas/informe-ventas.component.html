<div class="informe-ventas-container">
  <!-- Header y Filtros -->
  <div class="container">
    <!-- Header -->
    <div class="header-bar">
      <a mat-icon-button [routerLink]="['/dashboard-admin']">
        <mat-icon>arrow_back</mat-icon>
      </a>
      <h2 style="margin: 0;">Reporte de desempeño de ventas</h2>
    </div>

    <!-- Filtros -->
    <div class="filtros">
      <mat-form-field appearance="outline">
        <mat-label>Mes</mat-label>
        <mat-select [(ngModel)]="filtroMes" (selectionChange)="filtrar()">
          <mat-option [value]="null">Todos</mat-option>
          @for (mes of meses; track mes.value) {
            <mat-option [value]="mes.value">{{ mes.nombre }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Año</mat-label>
        <mat-select [(ngModel)]="filtroAnio" (selectionChange)="filtrar()">
          @for (anio of anios; track anio) {
            <mat-option [value]="anio">{{ anio }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Vendedor</mat-label>
        <mat-select [(ngModel)]="filtroVendedor" (selectionChange)="filtrar()">
          <mat-option value="">Todos</mat-option>
          @for (v of vendedores(); track v.id) {
            <mat-option [value]="v.id">{{ v.nombre }}</mat-option>
          }
        </mat-select>
      </mat-form-field>
      
      <mat-form-field appearance="outline">
        <mat-label>Producto</mat-label>
        <mat-select [(ngModel)]="filtroProducto" (selectionChange)="filtrar()">
          <mat-option value="">Todos</mat-option>
          @for (p of productos(); track p.sku) {
            <mat-option [value]="p.sku">{{ p.sku }} - {{ p.nombre }}</mat-option>
          }
        </mat-select>
      </mat-form-field>
      
      <mat-form-field appearance="outline">
        <mat-label>Región</mat-label>
        <mat-select [(ngModel)]="filtroRegion" (selectionChange)="filtrar()">
          <mat-option value="">Todas</mat-option>
          @for (r of regiones(); track r) {
            <mat-option [value]="r">{{ r }}</mat-option>
          }
        </mat-select>
      </mat-form-field>
    </div>

    <!-- Acciones de filtro -->
    <div class="filter-actions">
      <button mat-button type="button" (click)="limpiarFiltros()">
        <mat-icon>filter_list</mat-icon>
        Limpiar filtros
      </button>
    </div>
  </div>

  <!-- Tabla en contenedor separado -->
  <div class="container">
    <!-- Spinner de carga -->
    @if (loading()) {
      <div style="display: flex; justify-content: center; padding: 40px;">
        <mat-spinner></mat-spinner>
      </div>
    }

    <!-- Resumen de totales -->
    @if (!loading() && ventas.length > 0) {
      <div class="totales-resumen">
        <div class="total-item">
          <mat-icon>people</mat-icon>
          <div>
            <span class="total-label">Vendedores</span>
            <span class="total-value">{{ totales.vendedores }}</span>
          </div>
        </div>
        <div class="total-item">
          <mat-icon>inventory_2</mat-icon>
          <div>
            <span class="total-label">Productos</span>
            <span class="total-value">{{ totales.productos }}</span>
          </div>
        </div>
        <div class="total-item">
          <mat-icon>shopping_cart</mat-icon>
          <div>
            <span class="total-label">Volumen Total</span>
            <span class="total-value">{{ totales.volumen | number }}</span>
          </div>
        </div>
        <div class="total-item">
          <mat-icon>attach_money</mat-icon>
          <div>
            <span class="total-label">Valor Total</span>
            <span class="total-value">{{ totales.valor | currency:'COP':'symbol-narrow':'1.0-0' }}</span>
          </div>
        </div>
      </div>
    }

    @if (!loading()) {
      <div class="card">
        <div class="table-container">
          <table mat-table [dataSource]="dataSource" matSort class="modern-table">
            <ng-container matColumnDef="fecha">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Fecha</th>
              <td mat-cell *matCellDef="let row">{{ row.fecha | date:'dd/MM/yyyy' }}</td>
            </ng-container>

            <ng-container matColumnDef="vendedor">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Vendedor</th>
              <td mat-cell *matCellDef="let row">{{ row.vendedor }}</td>
            </ng-container>
            
            <ng-container matColumnDef="region">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Región</th>
              <td mat-cell *matCellDef="let row">{{ row.region }}</td>
            </ng-container>

            <ng-container matColumnDef="skuProducto">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>SKU</th>
              <td mat-cell *matCellDef="let row">{{ row.product_sku }}</td>
            </ng-container>
            
            <ng-container matColumnDef="producto">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Producto</th>
              <td mat-cell *matCellDef="let row">{{ row.product_name }}</td>
            </ng-container>
            
            <ng-container matColumnDef="tipoObjetivo">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Tipo Objetivo</th>
              <td mat-cell *matCellDef="let row">
                @if (row.tipo_objetivo) {
                  <span class="badge-objetivo" 
                        [ngClass]="row.tipo_objetivo === 'unidades' ? 'badge-unidades' : 'badge-monetario'">
                    {{ row.tipo_objetivo === 'unidades' ? 'Unidades' : 'Monetario' }}
                  </span>
                } @else {
                  <span class="sin-objetivo">N/A</span>
                }
              </td>
            </ng-container>
            
            <ng-container matColumnDef="volumenVentas">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Volumen de Ventas</th>
              <td mat-cell *matCellDef="let row">{{ row.volumen_ventas | number }}</td>
            </ng-container>
            
            <ng-container matColumnDef="valorTotal">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Valor Total</th>
              <td mat-cell *matCellDef="let row">{{ row.valor_total | currency:'COP':'symbol-narrow':'1.0-0' }}</td>
            </ng-container>
            
            <ng-container matColumnDef="valorObjetivo">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Valor Objetivo</th>
              <td mat-cell *matCellDef="let row">
                @if (row.valor_objetivo !== null) {
                  @if (row.tipo_objetivo === 'monetario') {
                    {{ row.valor_objetivo | currency:'COP':'symbol-narrow':'1.0-0' }}
                  } @else {
                    {{ row.valor_objetivo | number }}
                  }
                } @else {
                  <span class="sin-objetivo">N/A</span>
                }
              </td>
            </ng-container>

            <ng-container matColumnDef="cumplimiento">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>% Cumplimiento</th>
              <td mat-cell *matCellDef="let row">
                @if (row.cumplimiento_porcentaje !== null) {
                  <span [ngClass]="getCumplimientoClass(row.cumplimiento_porcentaje)">
                    {{ row.cumplimiento_porcentaje | number:'1.1-1' }}%
                  </span>
                } @else {
                  <span class="sin-objetivo">N/A</span>
                }
              </td>
            </ng-container>
            
            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
          </table>

          <!-- Mensaje cuando no hay datos -->
          @if (ventas.length === 0) {
            <div class="no-data">
              <mat-icon>info</mat-icon>
              <p>No se encontraron registros con los filtros seleccionados</p>
            </div>
          }
        </div>
        
        <!-- Paginación -->
        <mat-paginator 
          class="unified-paginator"
          [pageSize]="10" 
          [pageSizeOptions]="[5, 10, 20, 50]"
          showFirstLastButtons>
        </mat-paginator>
      </div>
      
      <!-- Acciones fuera de la card -->
      <div class="acciones">
        <button mat-raised-button color="accent" (click)="exportar('pdf')">
          <mat-icon>picture_as_pdf</mat-icon> 
          <span>Exportar PDF</span>
        </button>
        <button mat-raised-button color="accent" (click)="exportar('excel')">
          <mat-icon>table_view</mat-icon> 
          <span>Exportar Excel</span>
        </button>
      </div>
    }
  </div>
</div>
