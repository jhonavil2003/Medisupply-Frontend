
<div class="container">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
    <div style="display: flex; align-items: center; gap: 16px;">
      <a mat-icon-button [routerLink]="['/dashboard-admin']">
        <mat-icon>arrow_back</mat-icon>
      </a>
      <h2 style="margin: 0;">Gestión de proveedores</h2>
    </div>
    <button mat-raised-button color="primary" (click)="agregarProveedorAleatorio()" aria-label="Agregar proveedor" data-i18n="btn.register">
      <mat-icon>add</mat-icon> Agregar Proveedor
    </button>
  </div>
  <div class="search-bar" style="flex: 1;">
    <div class="search-wrap">
      <mat-form-field appearance="outline" class="search-field">
        <mat-label>Buscar proveedor</mat-label>
        <input matInput
          placeholder="Razón social, RUC, teléfono, correo, estado o certificación..."
          [(ngModel)]="filtroBusqueda"
          (ngModelChange)="filtrarProveedores()"
          (keyup.enter)="filtrarProveedores()"
          />
        @if (filtroBusqueda) {
          <button
            matSuffix
            mat-icon-button
            aria-label="Limpiar"
            (click)="filtroBusqueda=''; filtrarProveedores()" color="primary">
            <mat-icon>close</mat-icon>
          </button>
        }
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>
      <button mat-raised-button color="primary" class="search-btn" (click)="filtrarProveedores()">
        <mat-icon>search</mat-icon>
      </button>
    </div>
  </div>

  <div class="card">
    <table mat-table [dataSource]="dataSource" matSort class="modern-table">
      <ng-container matColumnDef="razonSocial">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Razón Social</th>
        <td mat-cell *matCellDef="let row">{{ row.razonSocial }}</td>
      </ng-container>
      <ng-container matColumnDef="ruc">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>RUC</th>
        <td mat-cell *matCellDef="let row">{{ row.ruc }}</td>
      </ng-container>
      <ng-container matColumnDef="telefono">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Teléfono</th>
        <td mat-cell *matCellDef="let row">{{ row.telefono }}</td>
      </ng-container>
      <ng-container matColumnDef="correoContacto">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Correo de contacto</th>
        <td mat-cell *matCellDef="let row">{{ row.correoContacto }}</td>
      </ng-container>
      <ng-container matColumnDef="estado">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Estado</th>
        <td mat-cell *matCellDef="let row">{{ row.estado }}</td>
      </ng-container>
      <ng-container matColumnDef="certificacionesVigentes">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Certificaciones vigentes</th>
        <td mat-cell *matCellDef="let row">
          @for (cert of row.certificacionesVigentes; track cert; let last = $last) {
            <span>
              {{ cert }}@if (!last) {
              <span>, </span>
            }
          </span>
        }
      </td>
    </ng-container>
    <ng-container matColumnDef="acciones">
      <th mat-header-cell *matHeaderCellDef>Acciones</th>
      <td mat-cell *matCellDef="let row; let i = index" class="actions">
        <button class="btn-icon" title="Ver" (click)="verProveedor(row)"><i class="fas fa-eye"></i></button>
        <button class="btn-icon" title="Editar" (click)="editarProveedor(row)"><i class="fas fa-edit"></i></button>
        <button class="btn-icon danger" title="Eliminar" (click)="eliminarProveedor(row)"><i class="fas fa-trash"></i></button>
      </td>
    </ng-container>
    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
  </table>
  <mat-paginator [pageSize]="10" [pageSizeOptions]="[5, 10, 20]"></mat-paginator>
</div>

<!-- Modal Edición -->
<div class="detalle-modal" [ngStyle]="{display: mostrarModal ? 'flex' : 'none'}">
  @if (mostrarModal) {
    <div class="detalle-content">
      <button mat-icon-button (click)="cancelarEdicionProveedor()" aria-label="Cerrar" class="close" type="button">
        <mat-icon>close</mat-icon>
      </button>
      <h2>{{ modoEdicion ? 'Editar Proveedor' : 'Crear Proveedor' }}</h2>
      <form [formGroup]="proveedorForm" (ngSubmit)="guardarEdicionProveedor()" class="form-container">
        <!-- Razon social full width -->
        <mat-form-field appearance="outline" floatLabel="always" class="form-field full">
          <mat-label>Razón Social</mat-label>
          <input matInput type="text" formControlName="razonSocial">
          <mat-error *ngIf="proveedorForm.get('razonSocial')?.touched && proveedorForm.get('razonSocial')?.invalid">
            Razón social es requerida (mínimo 3 caracteres).
          </mat-error>
        </mat-form-field>

        <!-- RUC / País -->
        <mat-form-field appearance="outline" floatLabel="always" class="form-field">
          <mat-label>RUC / NIT <span class="required">*</span></mat-label>
          <input matInput type="text" formControlName="ruc" maxlength="15" 
                 (keypress)="onlyNumbers($event)">
          <mat-error *ngIf="proveedorForm.get('ruc')?.touched && proveedorForm.get('ruc')?.invalid">
            @if (proveedorForm.get('ruc')?.errors?.['required']) {
              RUC es requerido.
            } @else if (proveedorForm.get('ruc')?.errors?.['minlength'] || proveedorForm.get('ruc')?.errors?.['maxlength']) {
              RUC debe tener entre 8-15 dígitos.
            } @else if (proveedorForm.get('ruc')?.errors?.['pattern']) {
              RUC debe contener solo números.
            }
          </mat-error>
        </mat-form-field>        <mat-form-field appearance="outline" floatLabel="always" class="form-field">
          <mat-label>País</mat-label>
          <input matInput type="text" formControlName="country">
          <mat-error *ngIf="proveedorForm.get('country')?.touched && proveedorForm.get('country')?.invalid">
            País es requerido.
          </mat-error>
        </mat-form-field>

        <!-- Telefono / Correo -->
        <mat-form-field appearance="outline" floatLabel="always" class="form-field">
          <mat-label>Teléfono</mat-label>
          <input matInput type="text" formControlName="telefono" maxlength="20" 
                 (keypress)="onlyPhoneChars($event)" placeholder="+57 300 123 4567">
          <mat-error *ngIf="proveedorForm.get('telefono')?.touched && proveedorForm.get('telefono')?.invalid">
            @if (proveedorForm.get('telefono')?.errors?.['required']) {
              Teléfono es requerido.
            } @else if (proveedorForm.get('telefono')?.errors?.['minlength']) {
              Teléfono debe tener al menos 7 caracteres.
            } @else if (proveedorForm.get('telefono')?.errors?.['maxlength']) {
              Teléfono no puede tener más de 20 caracteres.
            }
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" floatLabel="always" class="form-field">
          <mat-label>Correo de contacto</mat-label>
          <input matInput type="email" formControlName="correoContacto">
          <mat-error *ngIf="proveedorForm.get('correoContacto')?.touched && proveedorForm.get('correoContacto')?.invalid">
            Correo inválido.
          </mat-error>
        </mat-form-field>

        <!-- Website / Currency -->
        <mat-form-field appearance="outline" floatLabel="always" class="form-field">
          <mat-label>Sitio web</mat-label>
          <input matInput type="text" formControlName="website" placeholder="www.ejemplo.com">
          <mat-error *ngIf="proveedorForm.get('website')?.touched && proveedorForm.get('website')?.invalid">
            Ingrese una dirección web válida (ej: www.ejemplo.com)
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" floatLabel="always" class="form-field">
          <mat-label>Moneda</mat-label>
          <input matInput type="text" formControlName="currency" placeholder="USD, EUR, COP..." maxlength="3">
          <mat-error *ngIf="proveedorForm.get('currency')?.touched && proveedorForm.get('currency')?.invalid">
            Máximo 3 caracteres (ej: USD, EUR, COP)
          </mat-error>
        </mat-form-field>

        <!-- Direccion full width -->
        <mat-form-field appearance="outline" floatLabel="always" class="form-field full">
          <mat-label>Dirección (línea 1)</mat-label>
          <input matInput type="text" formControlName="addressLine1" placeholder="Calle, número, etc.">
        </mat-form-field>

        <!-- Ciudad / Estado -->
        <mat-form-field appearance="outline" floatLabel="always" class="form-field">
          <mat-label>Ciudad</mat-label>
          <input matInput type="text" formControlName="city">
        </mat-form-field>

        <mat-form-field appearance="outline" floatLabel="always" class="form-field">
          <mat-label>Departamento / Estado</mat-label>
          <input matInput type="text" formControlName="state">
        </mat-form-field>

        <!-- Payment terms / Credit limit -->
        <mat-form-field appearance="outline" floatLabel="always" class="form-field">
          <mat-label>Términos de pago</mat-label>
          <input matInput type="text" formControlName="paymentTerms" placeholder="e.g. 30 días">
        </mat-form-field>

        <mat-form-field appearance="outline" floatLabel="always" class="form-field">
          <mat-label>Límite de crédito</mat-label>
          <input matInput type="number" formControlName="creditLimit" min="0">
        </mat-form-field>

        <!-- Estado / Certificaciones -->
        <mat-form-field appearance="outline" floatLabel="always" class="form-field">
          <mat-label>Estado</mat-label>
          <mat-select formControlName="estado">
            <mat-option value="Activo">Activo</mat-option>
            <mat-option value="Inactivo">Inactivo</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" floatLabel="always" class="form-field">
          <mat-label>Certificaciones vigentes</mat-label>
          <input matInput type="text" formControlName="certificacionesVigentes" placeholder="Separadas por coma">
        </mat-form-field>

        <div class="form-actions">
          <button mat-flat-button color="primary" type="submit">Guardar</button>
        </div>
      </form>
    </div>
  }
</div>

<!-- Modal Detalle -->
<div class="detalle-modal" [ngStyle]="{display: mostrarDetalle ? 'flex' : 'none'}">
  @if (proveedorDetalle) {
    <div class="detalle-content">
      <button mat-icon-button (click)="cerrarDetalleProveedor()" aria-label="Cerrar" class="close" type="button">
        <mat-icon>close</mat-icon>
      </button>
      <h2>Detalle del Proveedor</h2>
      <p><strong>Razón Social:</strong> {{ proveedorDetalle.razonSocial }}</p>
      <p><strong>RUC:</strong> {{ proveedorDetalle.ruc }}</p>
      <p><strong>Teléfono:</strong> {{ proveedorDetalle.telefono }}</p>
      <p><strong>Correo de contacto:</strong> {{ proveedorDetalle.correoContacto }}</p>
      <p><strong>Estado:</strong> {{ proveedorDetalle.estado }}</p>
      <p><strong>Certificaciones vigentes:</strong>
      @if (proveedorDetalle.certificacionesVigentes && proveedorDetalle.certificacionesVigentes.length) {
        <span>
          @for (cert of proveedorDetalle.certificacionesVigentes; track cert; let last = $last) {
            <span>
              {{ cert }}@if (!last) {
              <span>, </span>
            }
          </span>
        }
      </span>
    } @else {
      Sin certificaciones
    }
  </p>
</div>
}
</div>
</div>
