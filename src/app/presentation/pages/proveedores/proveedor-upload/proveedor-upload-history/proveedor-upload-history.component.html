<div class="informe-ventas-container">
  <!-- Primer contenedor: Header y botón actualizar -->
  <div class="container">
    <!-- Header -->
    <div class="header-bar">
      <a mat-icon-button [routerLink]="['/proveedor-upload']">
        <mat-icon>arrow_back</mat-icon>
      </a>
      <h2>{{ 'BULK_UPLOAD_PROVIDERS.HISTORY.TITLE' | translate }}</h2>
      <div style="margin-left: auto;">
        <button mat-raised-button color="primary" (click)="refresh()">
          <mat-icon>refresh</mat-icon>
          {{ 'BULK_UPLOAD_PROVIDERS.HISTORY.REFRESH' | translate }}
        </button>
      </div>
    </div>
  </div>

  <!-- Segundo contenedor: KPIs y filtros -->
  <div class="container">
    <!-- Estadísticas KPIs -->
    @if (stats(); as statistics) {
      <div class="totales-resumen">
        <div class="total-item">
          <mat-icon>folder</mat-icon>
          <div>
            <span class="numero">{{ statistics.total_jobs }}</span>
            <span class="label">{{ 'BULK_UPLOAD_PROVIDERS.HISTORY.STATS.TOTAL_UPLOADS' | translate }}</span>
          </div>
        </div>

        <div class="total-item">
          <mat-icon>check_circle</mat-icon>
          <div>
            <span class="numero">{{ statistics.completed }}</span>
            <span class="label">{{ 'BULK_UPLOAD_PROVIDERS.HISTORY.STATS.COMPLETED' | translate }}</span>
          </div>
        </div>

        <div class="total-item">
          <mat-icon>sync</mat-icon>
          <div>
            <span class="numero">{{ statistics.in_progress }}</span>
            <span class="label">{{ 'BULK_UPLOAD_PROVIDERS.HISTORY.STATS.IN_PROGRESS' | translate }}</span>
          </div>
        </div>

        <div class="total-item">
          <mat-icon>error</mat-icon>
          <div>
            <span class="numero">{{ statistics.failed }}</span>
            <span class="label">{{ 'BULK_UPLOAD_PROVIDERS.HISTORY.STATS.FAILED' | translate }}</span>
          </div>
        </div>

        <div class="total-item">
          <mat-icon>business</mat-icon>
          <div>
            <span class="numero">{{ statistics.total_suppliers_created }}</span>
            <span class="label">{{ 'BULK_UPLOAD_PROVIDERS.HISTORY.STATS.PROVIDERS_IMPORTED' | translate }}</span>
          </div>
        </div>

        <div class="total-item">
          <mat-icon>trending_up</mat-icon>
          <div>
            <span class="numero">{{ statistics.average_success_rate.toFixed(1) }}%</span>
            <span class="label">{{ 'BULK_UPLOAD_PROVIDERS.HISTORY.STATS.AVERAGE_SUCCESS_RATE' | translate }}</span>
          </div>
        </div>
      </div>
    }

    <!-- Filtros -->
    <div class="filtros">
      <mat-form-field appearance="outline">
        <mat-label>{{ 'BULK_UPLOAD_PROVIDERS.HISTORY.FILTER_BY_STATUS' | translate }}</mat-label>
        <mat-select 
          [value]="selectedStatus()" 
          (selectionChange)="onStatusFilterChange($event.value)">
          @for (option of statusOptions; track option.value) {
            <mat-option [value]="option.value">{{ option.label }}</mat-option>
          }
        </mat-select>
      </mat-form-field>
    </div>
  </div>

  <!-- Tercer contenedor: Tabla -->
  <div class="container">
    @if (loading()) {
      <div class="loading-container">
        <mat-spinner></mat-spinner>
        <p>{{ 'BULK_UPLOAD_PROVIDERS.HISTORY.LOADING' | translate }}</p>
      </div>
    } @else {
      <div class="card">
        <div class="table-container">
          <table mat-table [dataSource]="jobs()" class="modern-table">
            <!-- Filename Column -->
            <ng-container matColumnDef="filename">
              <th mat-header-cell *matHeaderCellDef>{{ 'BULK_UPLOAD_PROVIDERS.HISTORY.TABLE.FILENAME' | translate }}</th>
              <td mat-cell *matCellDef="let job">
                <div class="filename-cell">
                  <mat-icon>description</mat-icon>
                  <span>{{ job.filename }}</span>
                </div>
              </td>
            </ng-container>

            <!-- Status Column -->
            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef>{{ 'BULK_UPLOAD_PROVIDERS.HISTORY.TABLE.STATUS' | translate }}</th>
              <td mat-cell *matCellDef="let job">
                <mat-chip [class]="getStatusColor(job.status)">
                  <mat-icon>{{ getStatusIcon(job.status) }}</mat-icon>
                  {{ getStatusText(job.status) }}
                </mat-chip>
              </td>
            </ng-container>

            <!-- Created At Column -->
            <ng-container matColumnDef="created_at">
              <th mat-header-cell *matHeaderCellDef>{{ 'BULK_UPLOAD_PROVIDERS.HISTORY.TABLE.CREATED_AT' | translate }}</th>
              <td mat-cell *matCellDef="let job">
                {{ job.created_at | date:'dd/MM/yyyy HH:mm' }}
              </td>
            </ng-container>

            <!-- Total Rows Column -->
            <ng-container matColumnDef="total_rows">
              <th mat-header-cell *matHeaderCellDef>{{ 'BULK_UPLOAD_PROVIDERS.HISTORY.TABLE.TOTAL_ROWS' | translate }}</th>
              <td mat-cell *matCellDef="let job">
                <strong>{{ job.total_rows }}</strong>
              </td>
            </ng-container>

            <!-- Successful Rows Column -->
            <ng-container matColumnDef="successful_rows">
              <th mat-header-cell *matHeaderCellDef>{{ 'BULK_UPLOAD_PROVIDERS.HISTORY.TABLE.SUCCESSFUL' | translate }}</th>
              <td mat-cell *matCellDef="let job">
                <span class="success-text">{{ job.successful_rows }}</span>
              </td>
            </ng-container>

            <!-- Failed Rows Column -->
            <ng-container matColumnDef="failed_rows">
              <th mat-header-cell *matHeaderCellDef>{{ 'BULK_UPLOAD_PROVIDERS.HISTORY.TABLE.FAILED' | translate }}</th>
              <td mat-cell *matCellDef="let job">
                <span class="error-text">{{ job.failed_rows }}</span>
              </td>
            </ng-container>

            <!-- Success Rate Column -->
            <ng-container matColumnDef="success_rate">
              <th mat-header-cell *matHeaderCellDef>{{ 'BULK_UPLOAD_PROVIDERS.HISTORY.TABLE.SUCCESS_RATE' | translate }}</th>
              <td mat-cell *matCellDef="let job">
                <div class="success-rate">
                  {{ job.success_rate.toFixed(1) }}%
                </div>
              </td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef>{{ 'BULK_UPLOAD_PROVIDERS.HISTORY.TABLE.ACTIONS' | translate }}</th>
              <td mat-cell *matCellDef="let job">
                @if (job.failed_rows > 0) {
                  <button 
                    mat-icon-button 
                    color="warn"
                    (click)="downloadErrors(job)"
                    [matTooltip]="'BULK_UPLOAD_PROVIDERS.HISTORY.TABLE.DOWNLOAD_ERRORS' | translate">
                    <mat-icon>download</mat-icon>
                  </button>
                }
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
          </table>

          @if (jobs().length === 0) {
            <div class="no-data">
              <mat-icon>inbox</mat-icon>
              <p>{{ 'BULK_UPLOAD_PROVIDERS.HISTORY.NO_RECORDS' | translate }}</p>
            </div>
          }
        </div>

        <!-- Paginador -->
        <mat-paginator
          class="unified-paginator"
          [length]="totalJobs()"
          [pageSize]="pageSize()"
          [pageIndex]="pageIndex()"
          [pageSizeOptions]="[5, 10, 25, 50]"
          (page)="onPageChange($event)"
          showFirstLastButtons>
        </mat-paginator>
      </div>
    }
  </div>
</div>
